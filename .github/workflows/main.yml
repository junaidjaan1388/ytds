# .github/workflows/youtube-downloader.yml
name: YouTube Downloader CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true
        type: string
      output_format:
        description: 'Output format'
        required: false
        default: 'mp4'
        type: choice
        options:
        - mp4
        - mp3
        - webm

env:
  PYTHON_VERSION: '3.10'
  OUTPUT_DIR: 'downloads'

jobs:
  test-downloader:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yt-dlp
        pip install -r requirements.txt

    - name: Run basic tests
      run: |
        python -c "import yt_dlp; print('yt-dlp version:', yt_dlp.version.__version__)"
        python -c "import sys; print('Python version:', sys.version)"

    - name: Test download functionality
      if: github.event_name == 'workflow_dispatch'
      run: |
        mkdir -p ${{ env.OUTPUT_DIR }}
        python scripts/downloader.py \
          --url "${{ github.event.inputs.video_url }}" \
          --format "${{ github.event.inputs.output_format }}" \
          --output "${{ env.OUTPUT_DIR }}"
      env:
        VIDEO_URL: ${{ github.event.inputs.video_url }}

    - name: Upload downloaded files
      if: github.event_name == 'workflow_dispatch' && success()
      uses: actions/upload-artifact@v4
      with:
        name: downloaded-videos
        path: ${{ env.OUTPUT_DIR }}/
        retention-days: 1
